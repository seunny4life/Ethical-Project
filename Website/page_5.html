<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DCU Research Ethics Application Form - Section 5</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Link to custom CSS -->
    <link href="/Design/styles.css" rel="stylesheet" />
</head>

<body>
    <!-- Section 5 - Participant Information and Informed Consent Procedures -->
    <div class="container">
        <h2 class="section-heading">PARTICIPANT INFORMATION AND INFORMED CONSENT PROCEDURES</h2>
        <br><br>
        <div class="form-container">
            <form id="consentForm" onsubmit="return validateForm(event)">

                <!-- Section 5.1 - Participant Information Sheet -->
                <fieldset class="fieldset">
                    <legend>5.1 Please confirm that the following items have been addressed in your Participant
                        Information Sheet:</legend>
                    <p>The items should be used as headings in the information sheet. Note the language used under each
                        item must reflect the participant age group and corresponding comprehension level– if your
                        participants have different comprehension levels (e.g. both adult and child participants) then
                        separate sheets must be prepared for each set.</p>
                    <p>Templates are available via the <a href="https://www.dcu.ie/researchsupport/research-ethics"
                            target="_blank">REC Forms - Applications, Templates and Amendments section</a> of the
                        Research Ethics website.</p>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Checklist – tick the relevant check box for each item</th>
                                <th>Yes</th>
                                <th>No</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Addition of radio button groups -->
                            <tr>
                                <td>Introductory Statement:</td>
                                <td><input type="radio" id="intro_statement_yes" name="intro_statement" value="yes"
                                        onclick="toggleTextarea()"></td>
                                <td><input type="radio" id="intro_statement_no" name="intro_statement" value="no"
                                        onclick="toggleTextarea()"></td>
                            </tr>
                            <tr>
                                <td>What is this research about?</td>
                                <td><input type="radio" id="research_topic_yes" name="research_topic" value="yes"
                                        onclick="toggleTextarea()"></td>
                                <td><input type="radio" id="research_topic_no" name="research_topic" value="no"
                                        onclick="toggleTextarea()"></td>
                            </tr>
                            <tr>
                                <td>Why is this research being conducted?</td>
                                <td><input type="radio" id="purpose_yes" name="purpose" value="yes"
                                        onclick="toggleTextarea()"></td>
                                <td><input type="radio" id="purpose_no" name="purpose" value="no"
                                        onclick="toggleTextarea()"></td>
                            </tr>
                            <tr>
                                <td>Why have you been invited to take part?</td>
                                <td><input type="radio" id="invitation_yes" name="invitation" value="yes"
                                        onclick="toggleTextarea()"></td>
                                <td><input type="radio" id="invitation_no" name="invitation" value="no"
                                        onclick="toggleTextarea()"></td>
                            </tr>
                            <tr>
                                <td>What will happen if you decide to take part in this research study?</td>
                                <td><input type="radio" id="participation_yes" name="participation" value="yes"
                                        onclick="toggleTextarea()"></td>
                                <td><input type="radio" id="participation_no" name="participation" value="no"
                                        onclick="toggleTextarea()"></td>
                            </tr>
                            <tr>
                                <td>How will your data be used?</td>
                                <td><input type="radio" id="data_usage_yes" name="data_usage" value="yes"
                                        onclick="toggleTextarea()"></td>
                                <td><input type="radio" id="data_usage_no" name="data_usage" value="no"
                                        onclick="toggleTextarea()"></td>
                            </tr>
                            <tr>
                                <td>How will your privacy be protected?</td>
                                <td><input type="radio" id="privacy_yes" name="privacy" value="yes"
                                        onclick="toggleTextarea()"></td>
                                <td><input type="radio" id="privacy_no" name="privacy" value="no"
                                        onclick="toggleTextarea()"></td>
                            </tr>
                            <tr>
                                <td>What are the benefits of taking part?</td>
                                <td><input type="radio" id="benefits_yes" name="benefits" value="yes"
                                        onclick="toggleTextarea()"></td>
                                <td><input type="radio" id="benefits_no" name="benefits" value="no"
                                        onclick="toggleTextarea()"></td>
                            </tr>
                            <tr>
                                <td>What are the risks of taking part?</td>
                                <td><input type="radio" id="risks_yes" name="risks" value="yes"
                                        onclick="toggleTextarea()"></td>
                                <td><input type="radio" id="risks_no" name="risks" value="no"
                                        onclick="toggleTextarea()"></td>
                            </tr>
                            <tr>
                                <td>Can you change your mind and withdraw?</td>
                                <td><input type="radio" id="withdrawal_yes" name="withdrawal" value="yes"
                                        onclick="toggleTextarea()"></td>
                                <td><input type="radio" id="withdrawal_no" name="withdrawal" value="no"
                                        onclick="toggleTextarea()"></td>
                            </tr>
                            <tr>
                                <td>How will you find out what happens with this project?</td>
                                <td><input type="radio" id="project_outcomes_yes" name="project_outcomes" value="yes"
                                        onclick="toggleTextarea()"></td>
                                <td><input type="radio" id="project_outcomes_no" name="project_outcomes" value="no"
                                        onclick="toggleTextarea()"></td>
                            </tr>
                            <tr>
                                <td>Contact details for further information:</td>
                                <td><input type="radio" id="contact_info_yes" name="contact_info" value="yes"
                                        onclick="toggleTextarea()"></td>
                                <td><input type="radio" id="contact_info_no" name="contact_info" value="no"
                                        onclick="toggleTextarea()"></td>
                            </tr>
                        </tbody>
                    </table>
                    <br>
                    <div class="form-group" id="noExplanation" style="display: none;">
                        <label for="location"><i>If you marked any item as No, please explain and justify
                                why:</i></label>
                        <textarea class="form-control" id="location" name="location" rows="5"
                            aria-label="Explanation for No responses"></textarea>
                    </div>
                </fieldset>
                <br>

                <!-- Section 5.2 - Informed Consent Procedures -->
                <fieldset class="fieldset">
                    <legend>5.2 Informed Consent Procedures – please confirm whether written consent is to be obtained:
                    </legend>
                    <div class="form-group">
                        <label for="consentRequired"><i>Will written consent be obtained?</i></label>
                        <select class="form-control" name="consentRequired" id="consentRequired"
                            onchange="toggleConsentDetails();" required>
                            <option value="" selected>Please select...</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                    <div id="consentDetails" style="display:none;">
                        <div class="form-group">
                            <label for="consentDescription"><i>If Yes, describe the procedures by which written consent
                                    will be obtained.</i></label>
                            <textarea class="form-control" name="consentDescription" id="consentDescription"
                                rows="5"></textarea>
                        </div>
                    </div>

                    <div id="noConsentDetails" style="display:none;">
                        <div class="form-group">
                            <label for="noConsentDescription"><i>If No, describe the procedures regarding how
                                    consent/assent will be obtained</i></label>
                            <textarea class="form-control" name="noConsentDescription" id="noConsentDescription"
                                rows="5"></textarea>
                        </div>
                    </div>

                    <div id="consentNote" style="display: none;">
                        <p>Since you indicated in 4.1 that personal data is collected, it is likely that consent would
                            be needed. If you disagree, indicate below why:</p>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="consentNotNeeded"
                                name="consentNotNeeded" onclick="toggleNoConsentJustification()">
                            <label class="form-check-label" for="consentNotNeeded">Consent not needed</label>
                        </div>


                        <div class="form-group" id="noConsentJustification" style="display:none;">
                            <textarea class="form-control" id="noConsentJustificationText"
                                name="noConsentJustificationText" rows="5"
                                placeholder="Explain why consent is not needed..."></textarea>
                        </div>
                    </div>

                </div>

                </fieldset>
                <br>

                <!-- Button to Previous and Next step -->
                <div class="buttons">
                    <!-- Previous Button -->
                    <button type="button" class="btn btn-secondary" onclick="history.back();">Previous</button>

                    <!-- Next Page Button -->
                    <button type="submit" class="btn btn-primary">Next Page</button>
                </div>
            </form>
        </div>
    </div>
    <br /><br />

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            // Check if personal data is involved from localStorage
            const personalDataInvolved = localStorage.getItem('personalDataInvolved') === 'true';
            if (personalDataInvolved) {
                document.getElementById('consentRequired').value = 'yes';
                document.getElementById('consentNote').style.display = 'block';
            }

            toggleConsentDetails();
            toggleTextarea();
            populateFormData(); // Ensure form data is populated from localStorage
        });

        // Function to toggle display of consent details based on user selection
        function toggleConsentDetails() {
            var consentRequired = document.getElementById('consentRequired').value;
            var consentDetailsDiv = document.getElementById('consentDetails');
            var noConsentDetailsDiv = document.getElementById('noConsentDetails');
            var consentNoteDiv = document.getElementById('consentNote');
            if (consentRequired === 'yes') {
                consentDetailsDiv.style.display = 'block';
                noConsentDetailsDiv.style.display = 'none';
                if (consentNoteDiv) {
                    consentNoteDiv.style.display = 'none';
                }
            } else if (consentRequired === 'no') {
                consentDetailsDiv.style.display = 'none';
                noConsentDetailsDiv.style.display = 'block';
                if (consentNoteDiv) {
                    consentNoteDiv.style.display = 'block';
                }
            } else {
                consentDetailsDiv.style.display = 'none';
                noConsentDetailsDiv.style.display = 'none';
            }
        }

        // Function to toggle display of explanation textarea when "No" is selected
        function toggleTextarea() {
            var noSelected = false;
            var allQuestions = ["intro_statement", "research_topic", "purpose", "invitation", "participation", "data_usage", "privacy", "benefits", "risks", "withdrawal", "project_outcomes", "contact_info"];
            allQuestions.forEach(function (question) {
                var noRadio = document.getElementById(question + '_no');
                if (noRadio && noRadio.checked) {
                    noSelected = true;
                }
            });
            document.getElementById('noExplanation').style.display = noSelected ? 'block' : 'none';
        }

        // Function to toggle display of no consent justification
        function toggleNoConsentJustification() {
            var noConsentNeeded = document.getElementById('consentNotNeeded').checked;
            document.getElementById('noConsentJustification').style.display = noConsentNeeded ? 'block' : 'none';
        }

        // Function to validate form before submission
        function validateForm(event) {
            event.preventDefault();

            var allQuestions = ["intro_statement", "research_topic", "purpose", "invitation", "participation", "data_usage", "privacy", "benefits", "risks", "withdrawal", "project_outcomes", "contact_info"];
            var locationFilled = document.getElementById('location').value.trim() !== '';
            var consentRequired = document.getElementById('consentRequired').value;
            var consentDescriptionFilled = document.getElementById('consentDescription').value.trim() !== '';
            var noConsentDescriptionFilled = document.getElementById('noConsentDescription').value.trim() !== '';
            var noConsentJustificationFilled = document.getElementById('noConsentJustificationText').value.trim() !== '';

            // Check if all questions are answered and explanations provided for "No" responses
            var allAnswered = allQuestions.every(function (question) {
                var yesChecked = document.getElementById(question + '_yes').checked;
                var noChecked = document.getElementById(question + '_no').checked;

                // Ensure that if "No" is selected, the textarea must be filled
                if (noChecked && !locationFilled) {
                    return false;
                }
                return yesChecked || noChecked;
            });

            // Validate form inputs
            if (!allAnswered || (document.getElementById('noExplanation').style.display === 'block' && !locationFilled) || !consentRequired || (consentRequired === 'yes' && !consentDescriptionFilled) || (consentRequired === 'no' && !noConsentDescriptionFilled) || (consentRequired === 'no' && document.getElementById('consentNote').style.display === 'block' && !noConsentJustificationFilled)) {
                alert('Please fill out all required fields and provide explanations for any "No" responses.');
                return false;
            }

            // Save form data to localStorage
            saveFormData();

            window.location.href = 'page_6.html'; // Redirect to next page
        }

        // Function to save form data to localStorage
        function saveFormData() {
            const formData = new FormData(document.getElementById('consentForm'));
            formData.forEach((value, key) => {
                if (value === "on") {  // Handle checkboxes correctly
                    localStorage.setItem(key, document.getElementById(key).checked ? "true" : "false");
                } else {
                    localStorage.setItem(key, value);
                }
            });
        }

        // Function to populate form with data from localStorage
        function populateFormData() {
            const savedData = Object.keys(localStorage).reduce((data, key) => {
                data[key] = localStorage.getItem(key);
                return data;
            }, {});

            for (const key in savedData) {
                if (savedData.hasOwnProperty(key)) {
                    const element = document.getElementsByName(key)[0];
                    if (element) {
                        if (element.type === 'checkbox' || element.type === 'radio') {
                            element.checked = savedData[key] === element.value;
                        } else {
                            element.value = savedData[key];
                        }
                    }
                }
            }
        }
    </script>
</body>

</html>
